default_platform(:android)
require 'fileutils'

def calculate_version_code(name)
  major, minor, patch = name.split('.').map(&:to_i)
  "#{major + 28}#{format('%02d', minor)}#{format('%03d', patch)}".to_i
end

def get_version_name!(options)
  vn = options[:version_name]
  UI.user_error!("version_name is required (e.g. version_name:1.2.3)") if vn.to_s.strip.empty?
  vn
end

platform :android do

  lane :build_github do |options|
    version_name = get_version_name!(options)
    version_code = calculate_version_code(version_name)

    gradle(
      task: ":app:assembleGithubRelease",
      properties: {
        "voice.versionName" => version_name,
        "voice.versionCode" => version_code,
        "voice.includeProprietaryLibraries" => "false"
      }
    )
    copy_artifacts(
      artifacts: ["app/build/outputs/apk/github/release/app-github-release.apk"]
    )
  end

  lane :build_play_aab do |options|
    version_name = get_version_name!(options)
    version_code = calculate_version_code(version_name)

    gradle(
      task: ":app:bundlePlayRelease",
      properties: {
        "voice.versionName" => version_name,
        "voice.versionCode" => version_code,
        "voice.includeProprietaryLibraries" => "true"
      }
    )

    copy_artifacts(
      artifacts: ["app/build/outputs/bundle/playRelease/app-play-release.aab"]
    )
  end

  lane :upload_internal do |options|
    aab_path = options[:aab_path]
    upload_to_play_store(
      track: 'internal',
      aab: aab_path,
      skip_upload_metadata: true,
      skip_upload_changelogs: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  lane :promote do |options|
    version_name = get_version_name!(options)
    version_code = calculate_version_code(version_name)

    supply(
      track: 'internal',
      track_promote_to: 'production',
      track_promote_release_status: 'inProgress',
      rollout: "0.001", # 0.1%
      version_code: version_code,
      skip_upload_metadata: true,
      skip_upload_changelogs: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end
end
