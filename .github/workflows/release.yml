name: Release

on:
  push:
    tags: [ "*" ]

env:
  PLAY_SERVICE_ACCOUNT: ${{ secrets.PLAY_SERVICE_ACCOUNT }}
  SIGNING_KEYSTORE_PLAY: ${{ secrets.SIGNING_KEYSTORE }}
  SIGNING_PROPERTIES_PLAY: ${{ secrets.SIGNING_PROPERTIES }}
  SIGNING_KEYSTORE_GITHUB: ${{ secrets.SIGNING_KEYSTORE_GITHUB }}
  SIGNING_PROPERTIES_GITHUB: ${{ secrets.SIGNING_PROPERTIES_GITHUB }}
  GOOGLE_SERVICES: ${{ secrets.GOOGLE_SERVICES }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: google-play
    outputs:
      tag: ${{ github.ref_name }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - uses: ./.github/actions/build_setup
      - name: Setup Signing
        run: ./ci_signing_setup.sh
      - name: Build Google Play AAB
        run: ./gradlew :app:bundlePlayRelease -Pvoice.versionName=${GITHUB_REF_NAME}
      - name: Build Proprietary APK
        run: ./gradlew :app:assembleGithubRelease -Pvoice.versionName=${GITHUB_REF_NAME}
      - name: Copy Proprietary APK
        run: |
          mkdir -p outputs
          cp app/build/outputs/apk/github/release/app-github-release.apk outputs/proprietary.apk
      - name: Build Libre APK
        run: ./gradlew :app:assembleGithubRelease -Pvoice.includeProprietaryLibraries=false -Pvoice.versionName=${GITHUB_REF_NAME}
      - name: Copy Libre APK
        run: cp app/build/outputs/apk/github/release/app-github-release.apk outputs/libre.apk
      - name: Upload APKs
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: github-apks
          path: outputs/*.apk
          retention-days: 30
      - name: Publish to Google Play
        run: fastlane deploy
      - name: Draft GitHub Release
        uses: softprops/action-gh-release@6cbd405e2c4e67a21c47fa9e383d020e4e28b836 # v2
        with:
          draft: true
          files: outputs/*.apk
