name: Release

on:
  push:
    tags: [ "*" ]

env:
  PLAY_SERVICE_ACCOUNT: ${{ secrets.PLAY_SERVICE_ACCOUNT }}
  SIGNING_KEYSTORE_PLAY: ${{ secrets.SIGNING_KEYSTORE }}
  SIGNING_PROPERTIES_PLAY: ${{ secrets.SIGNING_PROPERTIES }}
  SIGNING_KEYSTORE_GITHUB: ${{ secrets.SIGNING_KEYSTORE_GITHUB }}
  SIGNING_PROPERTIES_GITHUB: ${{ secrets.SIGNING_PROPERTIES_GITHUB }}
  GOOGLE_SERVICES: ${{ secrets.GOOGLE_SERVICES }}

jobs:

  build_github:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - uses: ./.github/actions/build_setup
      - name: Setup Signing
        run: ./scripts/ci_signing_setup.sh
      - name: Build GitHub APKs via Fastlane
        run: fastlane android build_github version_name:${GITHUB_REF_NAME}
      - name: Draft GitHub Release
        uses: softprops/action-gh-release@6cbd405e2c4e67a21c47fa9e383d020e4e28b836 # v2
        with:
          draft: true
          files: outputs/*.apk

  play_internal:
    runs-on: ubuntu-latest
    environment: google-play
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - uses: ./.github/actions/build_setup
      - name: Setup Signing
        run: ./scripts/ci_signing_setup.sh
      - name: Setup Play Access
        run: ./scripts/ci_setup_play_access.sh
      - name: Build & Upload to INTERNAL via Fastlane
        run: fastlane android build_and_upload_to_internal version_name:${GITHUB_REF_NAME}

  promote:
    runs-on: ubuntu-latest
    needs: play_internal
    environment: google-play
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Setup Play Access
        run: ./scripts/ci_setup_play_access.sh
      - name: Promote INTERNAL -> PRODUCTION (0.1%)
        run: fastlane android promote version_name:${GITHUB_REF_NAME}
