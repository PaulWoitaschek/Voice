name: Release

on:
  push:
    tags: [ "*" ]

env:
  PLAY_SERVICE_ACCOUNT: ${{ secrets.PLAY_SERVICE_ACCOUNT }}
  SIGNING_KEYSTORE_PLAY: ${{ secrets.SIGNING_KEYSTORE }}
  SIGNING_PROPERTIES_PLAY: ${{ secrets.SIGNING_PROPERTIES }}
  SIGNING_KEYSTORE_GITHUB: ${{ secrets.SIGNING_KEYSTORE_GITHUB }}
  SIGNING_PROPERTIES_GITHUB: ${{ secrets.SIGNING_PROPERTIES_GITHUB }}
  GOOGLE_SERVICES: ${{ secrets.GOOGLE_SERVICES }}

jobs:

  tests:
    uses: ./.github/workflows/ci.yml

  play_build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: ./.github/actions/build_setup
      - name: Setup Signing
        run: ./scripts/ci_signing_setup.sh
      - name: Build Play AAB
        run: fastlane android build_play_aab version:${GITHUB_REF_NAME}
      - name: Upload AAB artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: play-aab
          path: artifacts/app-play-release.aab
          retention-days: 14

  play_upload:
    runs-on: ubuntu-latest
    needs:
      - play_build
      - tests
    environment: google-play
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Setup Play Access
        run: ./scripts/ci_setup_play_access.sh
      - name: Download AAB artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: play-aab
      - name: Upload to INTERNAL
        run: fastlane android upload_internal version:${GITHUB_REF_NAME} aab_path:app-play-release.aab

  play_promote:
    runs-on: ubuntu-latest
    needs: play_upload
    environment: google-play
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Setup Play Access
        run: ./scripts/ci_setup_play_access.sh
      - name: Promote INTERNAL -> PRODUCTION (0.1%)
        run: fastlane android promote version:${GITHUB_REF_NAME}

  github_build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: ./.github/actions/build_setup
      - name: Setup Signing
        run: ./scripts/ci_signing_setup.sh
      - name: Build GitHub APKs
        run: fastlane android build_github version:${GITHUB_REF_NAME}
      - name: Upload APK artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: github-apks
          path: artifacts/*.apk
          retention-days: 30

  github_release:
    runs-on: ubuntu-latest
    needs:
      - github_build
      - tests
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Download APK artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: github-apks
          path: artifacts
      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          files: artifacts/*.apk
          generate_release_notes: true
