name: Release

on:
  push:
    tags: [ "*" ]

env:
  PLAY_SERVICE_ACCOUNT: ${{ secrets.PLAY_SERVICE_ACCOUNT }}
  SIGNING_KEYSTORE_PLAY: ${{ secrets.SIGNING_KEYSTORE }}
  SIGNING_PROPERTIES_PLAY: ${{ secrets.SIGNING_PROPERTIES }}
  SIGNING_KEYSTORE_GITHUB: ${{ secrets.SIGNING_KEYSTORE_GITHUB }}
  SIGNING_PROPERTIES_GITHUB: ${{ secrets.SIGNING_PROPERTIES_GITHUB }}
  GOOGLE_SERVICES: ${{ secrets.GOOGLE_SERVICES }}

jobs:

  tests:
    uses: ./.github/workflows/ci.yml

  play_build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - uses: ./.github/actions/build_setup
      - name: Setup Signing
        run: ./scripts/ci_signing_setup.sh
      - name: Build Play AAB
        run: fastlane android build_play_aab version_name:${GITHUB_REF_NAME}
      - name: Upload AAB artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: play-aab
          path: artifacts/app-play-release.aab
          retention-days: 14

  play_upload:
    runs-on: ubuntu-latest
    needs:
      - play_build
      - tests
    environment: google-play
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Setup Play Access
        run: ./scripts/ci_setup_play_access.sh
      - name: Download AAB artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: play-aab
      - name: Upload to INTERNAL
        run: fastlane android upload_internal version_name:${GITHUB_REF_NAME} aab_path:app-play-release.aab

  play_promote:
    runs-on: ubuntu-latest
    needs: play_upload
    environment: google-play
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Setup Play Access
        run: ./scripts/ci_setup_play_access.sh
      - name: Promote INTERNAL -> PRODUCTION (0.1%)
        run: fastlane android promote version_name:${GITHUB_REF_NAME}

  github_build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - uses: ./.github/actions/build_setup
      - name: Setup Signing
        run: ./scripts/ci_signing_setup.sh
      - name: Build GitHub APKs
        run: fastlane android build_github version_name:${GITHUB_REF_NAME}
      - name: Upload APK artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: github-apks
          path: artifacts/*.apk
          retention-days: 30

  github_release_draft:
    runs-on: ubuntu-latest
    needs:
      - github_build
      - tests
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Download APK artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: github-apks
          path: artifacts
      - name: Draft GitHub Release
        uses: softprops/action-gh-release@6cbd405e2c4e67a21c47fa9e383d020e4e28b836 # v2
        with:
          files: artifacts/*.apk
