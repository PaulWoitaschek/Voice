name: Release

on:
  push:
    tags: [ "*" ]

env:
  PLAY_SERVICE_ACCOUNT: ${{ secrets.PLAY_SERVICE_ACCOUNT }}
  SIGNING_KEYSTORE_PLAY: ${{ secrets.SIGNING_KEYSTORE }}
  SIGNING_PROPERTIES_PLAY: ${{ secrets.SIGNING_PROPERTIES }}
  SIGNING_KEYSTORE_GITHUB: ${{ secrets.SIGNING_KEYSTORE_GITHUB }}
  SIGNING_PROPERTIES_GITHUB: ${{ secrets.SIGNING_PROPERTIES_GITHUB }}
  GOOGLE_SERVICES: ${{ secrets.GOOGLE_SERVICES }}

jobs:

  tests:
    uses: ./.github/workflows/ci.yml

  play_build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - uses: ./.github/actions/build_setup
      - name: Setup Signing
        run: ./scripts/ci_signing_setup.sh
      - name: Build Play AAB
        run: fastlane android build_play_aab version:${GITHUB_REF_NAME}
      - name: Upload AAB artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: play-aab
          path: artifacts/app-play-release.aab
          retention-days: 14

  play_upload:
    runs-on: ubuntu-latest
    needs:
      - play_build
      - tests
    environment: google-play
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Setup Play Access
        run: ./scripts/ci_setup_play_access.sh
      - name: Download AAB artifact
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
        with:
          name: play-aab
      - name: Upload to INTERNAL
        run: fastlane android upload_internal version:${GITHUB_REF_NAME} aab_path:app-play-release.aab

  play_promote:
    runs-on: ubuntu-latest
    needs: play_upload
    environment: google-play
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Setup Play Access
        run: ./scripts/ci_setup_play_access.sh
      - name: Promote INTERNAL -> PRODUCTION (0.1%)
        run: fastlane android promote version:${GITHUB_REF_NAME}

  github_build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - uses: ./.github/actions/build_setup
      - name: Setup Signing
        run: ./scripts/ci_signing_setup.sh
      - name: Build GitHub APKs
        run: fastlane android build_github version:${GITHUB_REF_NAME}
      - name: Upload APK artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: github-apks
          path: artifacts/*.apk
          retention-days: 30

  github_release:
    runs-on: ubuntu-latest
    needs:
      - github_build
      - tests
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Download APK artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
        with:
          name: github-apks
          path: artifacts
      - name: Create GitHub Release
        uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090 # v2
        with:
          files: artifacts/*.apk
          generate_release_notes: true
